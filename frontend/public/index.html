<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Neurodata Conversion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .status-section {
            margin-top: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-idle { background: #e9ecef; color: #495057; }
        .status-uploading { background: #cfe2ff; color: #084298; }
        .status-detecting_format { background: #fff3cd; color: #664d03; }
        .status-converting { background: #d1ecf1; color: #0c5460; }
        .status-validating { background: #d1e7dd; color: #0a3622; }
        .status-completed { background: #d1e7dd; color: #0a3622; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-awaiting_user_input { background: #fff3cd; color: #664d03; }
        .status-awaiting_retry_approval { background: #fff3cd; color: #664d03; }

        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-level-info { color: #0dcaf0; }
        .log-level-warning { color: #ffc107; }
        .log-level-error { color: #dc3545; }
        .log-level-debug { color: #6c757d; }

        .format-selection {
            margin: 20px 0;
        }

        .format-btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .format-btn:hover {
            background: #667eea;
            color: white;
        }

        .retry-dialog {
            padding: 20px;
            background: #fff3cd;
            border-radius: 6px;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .download-section {
            text-align: center;
            padding: 20px;
            background: #d1e7dd;
            border-radius: 6px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group .help-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .success-banner {
            background: #d1e7dd;
            border-left: 5px solid #198754;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .warning-banner {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .error-banner {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .connection-status.connected {
            background: #d1e7dd;
            color: #0a3622;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ‚ö†Ô∏è Connecting...
    </div>

    <div class="container">
        <div class="header">
            <h1>üß† Agentic Neurodata Conversion</h1>
            <p>AI-assisted conversion to NWB format</p>
        </div>

        <div class="card">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h3>Drop your neurodata file here or click to browse</h3>
                <p style="color: #6c757d; margin-top: 10px;">Supported formats: SpikeGLX, OpenEphys, Neuropixels, and more</p>
                <input type="file" id="fileInput" class="file-input">
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
            </div>

            <div id="selectedFile" class="hidden" style="margin-top: 20px; text-align: center;">
                <p><strong>Selected:</strong> <span id="fileName"></span></p>
                <button class="btn" onclick="uploadFile()">Start Conversion</button>
                <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
            </div>
        </div>

        <div class="card" id="statusCard">
            <h2>Status</h2>
            <div class="status-section">
                <div class="status-badge status-idle" id="statusBadge">Idle</div>
                <div id="statusDetails"></div>
            </div>
        </div>

        <div class="card hidden" id="formatSelectionCard">
            <h2>‚ö†Ô∏è Format Selection Required</h2>
            <p>Could not automatically detect format. Please select:</p>
            <div class="format-selection" id="formatButtons"></div>
        </div>

        <div class="card hidden" id="retryCard">
            <h2>‚ö†Ô∏è Validation Issues Found</h2>
            <div class="retry-dialog">
                <p><strong>The converted NWB file has validation issues.</strong></p>
                <div id="issueBreakdown" style="margin: 20px 0;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">Auto-Fixable Issues:</h3>
                        <ul id="autoFixableList" style="margin-left: 20px;">
                            <li>Loading...</li>
                        </ul>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                        <h3 style="margin-bottom: 10px;">Requires Your Input:</h3>
                        <ul id="userInputRequiredList" style="margin-left: 20px;">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
                <p>Would you like to retry with corrections?</p>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="approveRetry()">üîÑ Retry with Corrections</button>
                    <button class="btn btn-secondary" onclick="rejectRetry()">‚ùå Decline Retry</button>
                </div>
            </div>
        </div>

        <div class="card hidden" id="passedWithIssuesCard">
            <h2 style="color: #856404;">‚ö†Ô∏è Conversion Completed with Minor Issues</h2>
            <div style="background: #fff3cd; padding: 20px; border-radius: 6px;">
                <p><strong>The NWB file was successfully created but has minor validation issues.</strong></p>
                <p>You can either accept the file as-is or attempt to improve it:</p>
                <div id="minorIssuesList" style="margin: 20px 0; padding: 15px; background: white; border-radius: 6px;">
                    <h3>Issues Found:</h3>
                    <ul id="minorIssuesContent" style="margin-left: 20px;">
                        <li>Loading...</li>
                    </ul>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="acceptAsIs()">‚úì Accept As-Is</button>
                    <button class="btn" onclick="attemptImprovement()">üîß Attempt Improvement</button>
                </div>
            </div>
        </div>

        <div class="modal hidden" id="userInputModal">
            <div class="modal-content">
                <h2>Additional Information Needed</h2>
                <p id="userInputPrompt">Please provide the following information:</p>
                <div id="userInputForm" style="margin: 20px 0;">
                    <!-- Dynamic form fields will be inserted here -->
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="submitUserInput()">Submit</button>
                    <button class="btn btn-secondary" onclick="closeUserInputModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="card hidden" id="downloadCard">
            <div class="download-section">
                <h2>‚úÖ Conversion Completed!</h2>
                <p style="margin: 15px 0;">Your NWB file is ready to download</p>
                <button class="btn" onclick="downloadNWB()">‚¨áÔ∏è Download NWB File</button>
                <button class="btn btn-secondary" onclick="resetSession()">Start New Conversion</button>
            </div>
        </div>

        <div class="card">
            <h2>Logs</h2>
            <div class="logs-container" id="logsContainer">
                <p style="color: #6c757d;">No logs yet...</p>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="refreshLogs()">Refresh Logs</button>
                <button class="btn btn-secondary" onclick="resetSession()">Reset Session</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws';
        let selectedFile = null;
        let statusInterval = null;
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let correctionContext = null;

        // File upload handling
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        uploadSection.addEventListener('click', () => {
            fileInput.click();
        });

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                showSelectedFile();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                showSelectedFile();
            }
        });

        function showSelectedFile() {
            document.getElementById('fileName').textContent = selectedFile.name;
            document.getElementById('selectedFile').classList.remove('hidden');
        }

        function clearSelection() {
            selectedFile = null;
            fileInput.value = '';
            document.getElementById('selectedFile').classList.add('hidden');
        }

        // WebSocket connection management
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                return;
            }

            try {
                websocket = new WebSocket(WS_URL);

                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                };

                websocket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };

                websocket.onclose = () => {
                    console.log('WebSocket closed');
                    updateConnectionStatus(false);

                    // Attempt to reconnect with exponential backoff
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                        reconnectAttempts++;
                        console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts})`);
                        setTimeout(connectWebSocket, delay);
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = '‚úì Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = reconnectAttempts >= MAX_RECONNECT_ATTEMPTS
                    ? '‚ö†Ô∏è Connection Failed'
                    : '‚ö†Ô∏è Connecting...';
            }
        }

        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);

            // Handle different event types
            if (message.event_type === 'status_change') {
                checkStatus(); // Refresh status display
            } else if (message.event_type === 'log') {
                addLog(message.data.level, message.data.message);
            } else if (message.event_type === 'validation_complete') {
                refreshLogs();
                checkStatus();
            } else if (message.event_type === 'conversion_complete') {
                checkStatus();
            }
        }

        async function uploadFile() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('metadata', JSON.stringify({
                session_description: 'Web UI conversion',
                experimenter: ['Web User']
            }));

            try {
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('info', `File uploaded: ${selectedFile.name}`);
                    startStatusPolling();
                } else {
                    addLog('error', `Upload failed: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                addLog('error', `Upload error: ${error.message}`);
            }
        }

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(checkStatus, 1000);
            checkStatus();
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();

                updateStatusDisplay(data);

                // Hide all conditional cards first
                document.getElementById('retryCard').classList.add('hidden');
                document.getElementById('passedWithIssuesCard').classList.add('hidden');
                document.getElementById('downloadCard').classList.add('hidden');

                // Handle different states based on validation_status
                if (data.status === 'awaiting_user_input') {
                    stopStatusPolling();
                    // Check if this is for metadata input (from retry flow)
                    await checkForUserInputRequest();
                } else if (data.status === 'awaiting_retry_approval') {
                    stopStatusPolling();
                    await showRetryDialog();
                } else if (data.status === 'completed') {
                    stopStatusPolling();

                    // Check validation status for status-aware UI
                    if (data.validation_status === 'passed') {
                        // Clean PASSED - show download with success banner
                        showDownload('success');
                    } else if (data.validation_status === 'passed_with_issues') {
                        // PASSED_WITH_ISSUES - show improvement option
                        await showPassedWithIssues();
                    } else {
                        // Default completed state
                        showDownload('default');
                    }
                    refreshLogs();
                } else if (data.status === 'failed') {
                    stopStatusPolling();
                    addLog('error', 'Conversion failed');
                    refreshLogs();
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }

        function updateStatusDisplay(data) {
            const badge = document.getElementById('statusBadge');
            badge.className = `status-badge status-${data.status}`;
            badge.textContent = data.status.replace(/_/g, ' ').toUpperCase();

            const details = document.getElementById('statusDetails');
            details.innerHTML = `
                <p><strong>Correction Attempt:</strong> ${data.correction_attempt}</p>
                <p><strong>Can Retry:</strong> ${data.can_retry ? 'Yes' : 'No'}</p>
                ${data.input_path ? `<p><strong>Input:</strong> ${data.input_path}</p>` : ''}
                ${data.output_path ? `<p><strong>Output:</strong> ${data.output_path}</p>` : ''}
            `;
        }

        async function showRetryDialog() {
            // Fetch correction context from new endpoint
            try {
                const response = await fetch(`${API_BASE}/api/correction-context`);
                const data = await response.json();

                correctionContext = data;

                // Update UI with issue breakdown
                const autoFixableList = document.getElementById('autoFixableList');
                const userInputRequiredList = document.getElementById('userInputRequiredList');

                if (data.status === 'available') {
                    // Display auto-fixable issues
                    if (data.auto_fixable && data.auto_fixable.length > 0) {
                        autoFixableList.innerHTML = data.auto_fixable.map(issue => `
                            <li>
                                <strong>${issue.issue}</strong><br>
                                <small style="color: #6c757d;">${issue.suggestion}</small>
                            </li>
                        `).join('');
                    } else {
                        autoFixableList.innerHTML = '<li>None</li>';
                    }

                    // Display user input required issues
                    if (data.user_input_required && data.user_input_required.length > 0) {
                        userInputRequiredList.innerHTML = data.user_input_required.map(issue => `
                            <li>
                                <strong>${issue.issue}</strong><br>
                                <small style="color: #6c757d;">${issue.suggestion}</small>
                            </li>
                        `).join('');
                    } else {
                        userInputRequiredList.innerHTML = '<li>None - all issues can be auto-fixed</li>';
                    }
                } else {
                    // Fallback if no context available
                    autoFixableList.innerHTML = '<li>Validation issues found - check logs for details</li>';
                    userInputRequiredList.innerHTML = '<li>None</li>';
                }

            } catch (error) {
                console.error('Error fetching correction context:', error);
                // Fallback display
                document.getElementById('autoFixableList').innerHTML = '<li>Error loading issue details</li>';
                document.getElementById('userInputRequiredList').innerHTML = '<li>Check logs for details</li>';
            }

            document.getElementById('retryCard').classList.remove('hidden');
        }

        async function showPassedWithIssues() {
            // Fetch validation results to show minor issues
            try {
                const response = await fetch(`${API_BASE}/api/logs?limit=50`);
                const data = await response.json();

                // Parse logs to find validation issues
                const issuesLog = data.logs.find(log =>
                    log.message.includes('validation') ||
                    log.message.includes('warning')
                );

                const minorIssuesContent = document.getElementById('minorIssuesContent');
                minorIssuesContent.innerHTML = '<li>Minor validation warnings found (check logs for details)</li>';

            } catch (error) {
                console.error('Error fetching validation results:', error);
            }

            document.getElementById('passedWithIssuesCard').classList.remove('hidden');
        }

        function showDownload(mode = 'default') {
            const downloadCard = document.getElementById('downloadCard');
            const downloadSection = downloadCard.querySelector('.download-section');

            // Update styling based on mode
            if (mode === 'success') {
                downloadSection.style.background = '#d1e7dd';
                downloadSection.innerHTML = `
                    <h2>‚úÖ Conversion Completed Successfully!</h2>
                    <div class="success-banner">
                        <strong>Perfect!</strong> Your NWB file passed all validation checks with no issues.
                    </div>
                    <p style="margin: 15px 0;">Your NWB file is ready to download and upload to DANDI</p>
                    <button class="btn" onclick="downloadNWB()">‚¨áÔ∏è Download NWB File</button>
                    <button class="btn btn-secondary" onclick="resetSession()">Start New Conversion</button>
                `;
            } else {
                downloadSection.style.background = '#d1e7dd';
                downloadSection.innerHTML = `
                    <h2>‚úÖ Conversion Completed!</h2>
                    <p style="margin: 15px 0;">Your NWB file is ready to download</p>
                    <button class="btn" onclick="downloadNWB()">‚¨áÔ∏è Download NWB File</button>
                    <button class="btn btn-secondary" onclick="resetSession()">Start New Conversion</button>
                `;
            }

            downloadCard.classList.remove('hidden');
        }

        async function acceptAsIs() {
            // User accepts the PASSED_WITH_ISSUES file
            document.getElementById('passedWithIssuesCard').classList.add('hidden');
            showDownload('default');
            addLog('info', 'User accepted file with minor issues');
        }

        async function attemptImprovement() {
            // User wants to attempt fixing the minor issues
            try {
                const response = await fetch(`${API_BASE}/api/retry-approval`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({decision: 'approve'})
                });

                if (response.ok) {
                    document.getElementById('passedWithIssuesCard').classList.add('hidden');
                    startStatusPolling();
                    addLog('info', 'Attempting to improve file quality...');
                } else {
                    addLog('error', 'Failed to start improvement process');
                }
            } catch (error) {
                addLog('error', `Improvement error: ${error.message}`);
            }
        }

        // Check for user input requests from backend
        async function checkForUserInputRequest() {
            try {
                // Try to fetch correction context which may contain required_fields
                const response = await fetch(`${API_BASE}/api/correction-context`);
                const data = await response.json();

                // Also check logs for user input requirements
                const logsResponse = await fetch(`${API_BASE}/api/logs?limit=10`);
                const logsData = await logsResponse.json();

                const userInputLog = logsData.logs.find(log =>
                    log.message.includes('User input required') && log.context
                );

                if (userInputLog && userInputLog.context.required_fields) {
                    // Show user input modal with required fields
                    showUserInputModal(userInputLog.context.required_fields);
                } else {
                    addLog('info', 'User input required - check logs for details');
                }
            } catch (error) {
                console.error('Error checking for user input request:', error);
            }
        }

        // User input modal functions
        function showUserInputModal(fields) {
            const modal = document.getElementById('userInputModal');
            const form = document.getElementById('userInputForm');

            // Clear previous form
            form.innerHTML = '';

            // Create form fields dynamically
            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = field.label;
                label.setAttribute('for', field.name);

                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    field.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                } else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                } else {
                    input = document.createElement('input');
                    input.type = field.type || 'text';
                }

                input.id = field.name;
                input.name = field.name;
                input.required = field.required || false;

                if (field.placeholder) {
                    input.placeholder = field.placeholder;
                }

                formGroup.appendChild(label);
                formGroup.appendChild(input);

                if (field.helpText) {
                    const helpText = document.createElement('div');
                    helpText.className = 'help-text';
                    helpText.textContent = field.helpText;
                    formGroup.appendChild(helpText);
                }

                form.appendChild(formGroup);
            });

            modal.classList.remove('hidden');
        }

        function closeUserInputModal() {
            document.getElementById('userInputModal').classList.add('hidden');
        }

        async function submitUserInput() {
            const form = document.getElementById('userInputForm');
            const inputs = form.querySelectorAll('input, select, textarea');

            const inputData = {};
            inputs.forEach(input => {
                inputData[input.name] = input.value;
            });

            try {
                const response = await fetch(`${API_BASE}/api/user-input`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({input_data: inputData})
                });

                if (response.ok) {
                    closeUserInputModal();
                    startStatusPolling();
                    addLog('info', 'User input submitted successfully');
                } else {
                    const data = await response.json();
                    addLog('error', `Failed to submit input: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                addLog('error', `Input submission error: ${error.message}`);
            }
        }

        async function approveRetry() {
            try {
                const response = await fetch(`${API_BASE}/api/retry-approval`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({decision: 'approve'})
                });

                if (response.ok) {
                    document.getElementById('retryCard').classList.add('hidden');
                    startStatusPolling();
                }
            } catch (error) {
                addLog('error', `Retry approval error: ${error.message}`);
            }
        }

        async function rejectRetry() {
            try {
                const response = await fetch(`${API_BASE}/api/retry-approval`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({decision: 'reject'})
                });

                document.getElementById('retryCard').classList.add('hidden');
                checkStatus();
            } catch (error) {
                addLog('error', `Retry rejection error: ${error.message}`);
            }
        }

        async function downloadNWB() {
            window.location.href = `${API_BASE}/api/download/nwb`;
        }

        async function resetSession() {
            try {
                await fetch(`${API_BASE}/api/reset`, {method: 'POST'});
                location.reload();
            } catch (error) {
                addLog('error', `Reset error: ${error.message}`);
            }
        }

        async function refreshLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs?limit=50`);
                const data = await response.json();

                const container = document.getElementById('logsContainer');
                container.innerHTML = '';

                if (data.logs.length === 0) {
                    container.innerHTML = '<p style="color: #6c757d;">No logs yet...</p>';
                    return;
                }

                data.logs.reverse().forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    entry.innerHTML = `
                        <span style="color: #6c757d;">[${time}]</span>
                        <span class="log-level-${log.level}">[${log.level.toUpperCase()}]</span>
                        ${log.message}
                    `;
                    container.appendChild(entry);
                });
            } catch (error) {
                console.error('Log refresh error:', error);
            }
        }

        function addLog(level, message) {
            const container = document.getElementById('logsContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <span style="color: #6c757d;">[${time}]</span>
                <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                ${message}
            `;
            container.insertBefore(entry, container.firstChild);
        }

        // Initialize
        connectWebSocket();
        refreshLogs();
        checkStatus();
    </script>
</body>
</html>
