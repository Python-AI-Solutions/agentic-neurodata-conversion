name: CI/CD Pipeline

on:
  push:
    branches: ['**']  # Run on all branch pushes

# Least privilege permissions
permissions:
  contents: read
  pull-requests: read

jobs:
  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.4.1
        with:
          pixi-version: latest

      - name: Run pre-commit checks
        run: pixi run -e default pre-commit run --all-files
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.13']

    # Neo4j service container for integration tests
    services:
      neo4j:
        image: neo4j:5.15
        env:
          NEO4J_AUTH: neo4j/test-neo4j-password
          NEO4J_PLUGINS: '["apoc"]'
          NEO4J_dbms_security_procedures_unrestricted: apoc.*
          NEO4J_dbms_memory_pagecache_size: 512M
          NEO4J_dbms_memory_heap_initial__size: 512M
          NEO4J_dbms_memory_heap_max__size: 1G
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test-neo4j-password 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # API key for tests
      ANTHROPIC_API_KEY: sk-ant-test-key-for-ci-only-not-used-in-tests
      # Neo4j connection for integration tests (points to service container)
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: test-neo4j-password
      NEO4J_DATABASE: neo4j
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.4.1
        with:
          pixi-version: latest

      - name: Install dependencies
        run: pixi install

      - name: Initialize Neo4j with test data
        run: |
          echo "‚è≥ Waiting for Neo4j to be ready..."
          sleep 10
          echo "üì¶ Loading ontologies..."
          pixi run python -m agentic_neurodata_conversion.kg_service.scripts.load_ontologies
          echo "üìù Loading schema fields..."
          pixi run python -m agentic_neurodata_conversion.kg_service.scripts.load_schema_fields
          echo "‚úÖ Neo4j initialized with 96 ontology terms and 25 schema fields"

      - name: Run smoke tests (fast fail)
        run: pixi run test-smoke
        continue-on-error: false  # Fast fail on critical path issues

      - name: Run unit tests
        run: pixi run test-unit
        continue-on-error: false

      - name: Run integration tests
        run: pixi run test-integration
        continue-on-error: false  # Integration test failures must block CI

      - name: Generate coverage report with threshold check
        run: pixi run -e default pytest tests --cov=agentic_neurodata_conversion --cov-report=xml --cov-report=term-missing --cov-fail-under=60
        continue-on-error: false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false  # Don't block CI if Codecov fails (optional service)
          flags: unittests
          name: codecov-${{ matrix.python-version }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, test]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "Lint and Format: ${{ needs.lint-and-format.result }}"
          echo "Tests: ${{ needs.test.result }}"

          if [ "${{ needs.lint-and-format.result }}" != "success" ]; then
            echo "‚ùå Code quality checks failed"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "‚ùå Tests failed"
            exit 1
          fi

          echo "‚úÖ All checks passed!"
