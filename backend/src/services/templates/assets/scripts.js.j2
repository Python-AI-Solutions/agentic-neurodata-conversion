// NWB Evaluation Report Interactive Features
// Embedded, self-contained JavaScript - no external dependencies

(function() {
    'use strict';

    // ========================================
    // Initialize on page load
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        initializeSearch();
        initializeFilters();
        initializeTooltips();
        initializeExpandCollapse();
        initializeCopyButtons();
    });

    // ========================================
    // Search and Filter Issues
    // ========================================
    function initializeSearch() {
        const searchInput = document.getElementById('issue-search');
        if (!searchInput) return;

        searchInput.addEventListener('input', debounce(filterIssues, 300));
    }

    function initializeFilters() {
        const severityFilter = document.getElementById('severity-filter');
        if (!severityFilter) return;

        severityFilter.addEventListener('change', filterIssues);
    }

    function filterIssues() {
        const searchTerm = document.getElementById('issue-search')?.value.toLowerCase() || '';
        const severityFilter = document.getElementById('severity-filter')?.value || 'all';

        const issueCards = document.querySelectorAll('.issue-card');
        let visibleCount = 0;

        issueCards.forEach(card => {
            const message = card.querySelector('.issue-message')?.textContent.toLowerCase() || '';
            const severity = card.dataset.severity || '';

            const matchesSearch = !searchTerm || message.includes(searchTerm);
            const matchesSeverity = severityFilter === 'all' || severity === severityFilter;

            if (matchesSearch && matchesSeverity) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        updateResultsCount(visibleCount, issueCards.length);
    }

    function updateResultsCount(visible, total) {
        let countElement = document.getElementById('results-count');
        if (!countElement) {
            countElement = document.createElement('div');
            countElement.id = 'results-count';
            countElement.style.cssText = 'margin: 1rem 0; color: #6b7280; font-size: 0.9rem;';
            const issuesSection = document.querySelector('.issues-section');
            if (issuesSection) {
                issuesSection.insertBefore(countElement, issuesSection.querySelector('.issues-list'));
            }
        }

        if (visible === 0) {
            countElement.innerHTML = '<div class="no-results">No issues match your filters</div>';
        } else if (visible < total) {
            countElement.textContent = `Showing ${visible} of ${total} issues`;
        } else {
            countElement.textContent = '';
        }
    }

    // ========================================
    // Expand/Collapse Functionality
    // ========================================
    function initializeExpandCollapse() {
        // Issue cards
        document.querySelectorAll('.issue-header').forEach(header => {
            header.addEventListener('click', function() {
                toggleIssue(this.closest('.issue-card'));
            });
        });

        // Expandable sections
        document.querySelectorAll('.expandable h3').forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                this.parentElement.classList.toggle('collapsed');
            });
        });
    }

    function toggleIssue(card) {
        if (!card) return;

        const details = card.querySelector('.issue-details');
        if (!details) return;

        details.classList.toggle('collapsed');
        card.classList.toggle('expanded');
    }

    window.toggleIssue = toggleIssue; // Make available globally for onclick

    // ========================================
    // Copy to Clipboard
    // ========================================
    function initializeCopyButtons() {
        document.querySelectorAll('.copy-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                copyToClipboard(this);
            });
        });
    }

    function copyToClipboard(button) {
        // Find the code element to copy
        const codeElement = button.previousElementSibling;
        if (!codeElement) return;

        const text = codeElement.textContent;

        // Use modern clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(button, true);
            }).catch(() => {
                // Fallback for older browsers
                fallbackCopyToClipboard(text, button);
            });
        } else {
            fallbackCopyToClipboard(text, button);
        }
    }

    function fallbackCopyToClipboard(text, button) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            showCopyFeedback(button, true);
        } catch (err) {
            showCopyFeedback(button, false);
        }

        document.body.removeChild(textarea);
    }

    function showCopyFeedback(button, success) {
        const originalText = button.textContent;
        button.textContent = success ? '✅' : '❌';
        button.disabled = true;

        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }

    window.copyToClipboard = copyToClipboard; // Make available globally for onclick

    // ========================================
    // Tooltips
    // ========================================
    function initializeTooltips() {
        // Provenance badges already have CSS hover tooltips
        // This is for any additional tooltip needs
    }

    // ========================================
    // Export to JSON
    // ========================================
    window.exportJSON = function() {
        if (typeof reportData === 'undefined') {
            alert('Report data not available for export');
            return;
        }

        const dataStr = JSON.stringify(reportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nwb_report_${reportData.session_id || 'export'}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // ========================================
    // Copy Share Link
    // ========================================
    window.copyShareLink = function() {
        const url = window.location.href;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied to clipboard!', 'success');
            }).catch(() => {
                fallbackCopyShareLink(url);
            });
        } else {
            fallbackCopyShareLink(url);
        }
    };

    function fallbackCopyShareLink(url) {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        } catch (err) {
            showNotification('Failed to copy link', 'error');
        }

        document.body.removeChild(textarea);
    }

    // ========================================
    // Print Optimization
    // ========================================
    window.addEventListener('beforeprint', function() {
        // Expand all collapsed sections for printing
        document.querySelectorAll('.issue-details.collapsed').forEach(details => {
            details.classList.remove('collapsed');
            details.dataset.wasCollapsed = 'true';
        });

        document.querySelectorAll('.expandable.collapsed').forEach(section => {
            section.classList.remove('collapsed');
            section.dataset.wasCollapsed = 'true';
        });
    });

    window.addEventListener('afterprint', function() {
        // Restore collapsed state
        document.querySelectorAll('.issue-details[data-was-collapsed]').forEach(details => {
            details.classList.add('collapsed');
            delete details.dataset.wasCollapsed;
        });

        document.querySelectorAll('.expandable[data-was-collapsed]').forEach(section => {
            section.classList.add('collapsed');
            delete section.dataset.wasCollapsed;
        });
    });

    // ========================================
    // Utility Functions
    // ========================================
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#dc2626' : '#3b82f6'};
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Add CSS animations for notifications
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // ========================================
    // Keyboard Shortcuts
    // ========================================
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + K: Focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('issue-search');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }

        // Ctrl/Cmd + P: Print
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            // Browser handles this natively
        }

        // Esc: Clear search
        if (e.key === 'Escape') {
            const searchInput = document.getElementById('issue-search');
            if (searchInput && searchInput === document.activeElement) {
                searchInput.value = '';
                filterIssues();
                searchInput.blur();
            }
        }
    });

    // ========================================
    // Performance: Lazy Load Images (if any)
    // ========================================
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                }
            });
        });

        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }

    // ========================================
    // Analytics (optional, for tracking usage)
    // ========================================
    // Track report views, issue interactions, etc.
    // This would be implemented based on your analytics needs

    // ========================================
    // ENHANCED REPORT FEATURES
    // ========================================

    // Collapsible Sections Toggle
    window.toggleSection = function(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        const content = section.querySelector('.collapsible-content');
        if (!content) return;

        const isOpen = section.classList.contains('open');

        if (isOpen) {
            // Collapse
            content.style.maxHeight = '0';
            section.classList.remove('open');
        } else {
            // Expand
            // Calculate the full height
            content.style.maxHeight = content.scrollHeight + 'px';
            section.classList.add('open');

            // After animation, set to 'none' so it can adjust if content changes
            setTimeout(() => {
                if (section.classList.contains('open')) {
                    content.style.maxHeight = 'none';
                }
            }, 300);
        }
    };

    // Expandable Content Toggle
    window.toggleExpand = function(element) {
        element.classList.toggle('open');
        const content = element.nextElementSibling;
        if (content) {
            content.classList.toggle('open');
        }
    };

    // Animate Progress Bars and Circular Charts on Load
    function animateProgressIndicators() {
        // Animate linear progress bars
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });

        // Animate circular progress indicators
        const circles = document.querySelectorAll('.score-circle');
        circles.forEach(circle => {
            const scoreText = circle.querySelector('.score-text');
            if (scoreText) {
                const score = parseInt(scoreText.textContent.replace('%', '')) || 0;
                const circumference = 2 * Math.PI * 45; // radius is 45
                const offset = circumference - (score / 100) * circumference;

                const fillCircle = circle.querySelector('circle.fill');
                if (fillCircle) {
                    fillCircle.style.strokeDasharray = circumference;
                    fillCircle.style.strokeDashoffset = circumference;

                    setTimeout(() => {
                        fillCircle.style.strokeDashoffset = offset;
                    }, 500);
                }
            }
        });
    }

    // Initialize Enhanced Features on Page Load
    function initializeEnhancedFeatures() {
        animateProgressIndicators();

        // Add smooth scroll to Quick Action buttons
        document.querySelectorAll('.quick-action').forEach(button => {
            button.addEventListener('click', function(e) {
                const targetId = this.getAttribute('data-scroll-to');
                if (targetId) {
                    e.preventDefault();
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        });

        // Initialize all collapsible sections as closed by default
        document.querySelectorAll('.collapsible-section').forEach(section => {
            if (!section.classList.contains('open')) {
                const content = section.querySelector('.collapsible-content');
                if (content) {
                    content.style.maxHeight = '0';
                }
            }
        });

        console.log('Enhanced report features initialized');
    }

    // Call on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeEnhancedFeatures);
    } else {
        initializeEnhancedFeatures();
    }

    // ========================================
    // Detailed Process Logs Filtering
    // ========================================
    window.filterDetailedLogs = function() {
        const levelFilter = document.getElementById('log-level-filter')?.value || 'all';
        const searchTerm = document.getElementById('log-search')?.value.toLowerCase() || '';

        const logEntries = document.querySelectorAll('.log-entry');

        logEntries.forEach(entry => {
            const level = entry.dataset.level || '';
            const searchable = entry.dataset.searchable || '';

            const matchesLevel = levelFilter === 'all' || level === levelFilter;
            const matchesSearch = !searchTerm || searchable.includes(searchTerm);

            if (matchesLevel && matchesSearch) {
                entry.classList.remove('filtered-out');
            } else {
                entry.classList.add('filtered-out');
            }
        });
    };

    window.searchDetailedLogs = function() {
        filterDetailedLogs();
    };

    // ========================================
    // Toggle Log Context Display
    // ========================================
    window.toggleLogContext = function(button) {
        const container = button.closest('.log-context-container');
        if (!container) return;

        const context = container.querySelector('.log-context');
        const toggleIcon = button.querySelector('.toggle-icon');

        if (!context) return;

        if (context.style.display === 'none' || !context.style.display) {
            context.style.display = 'block';
            button.textContent = '';
            const icon = document.createElement('span');
            icon.className = 'toggle-icon';
            icon.textContent = '▼';
            button.appendChild(icon);
            button.appendChild(document.createTextNode(' Hide Context'));
            button.classList.add('expanded');
        } else {
            context.style.display = 'none';
            button.textContent = '';
            const icon = document.createElement('span');
            icon.className = 'toggle-icon';
            icon.textContent = '▶';
            button.appendChild(icon);
            button.appendChild(document.createTextNode(' Show Context'));
            button.classList.remove('expanded');
        }
    };

    console.log('NWB Enhanced Report loaded successfully');
})();