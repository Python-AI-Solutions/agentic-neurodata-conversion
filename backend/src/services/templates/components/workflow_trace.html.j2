{# Workflow Trace Component #}
<section class="section workflow-trace-section collapsible-section open" id="workflow-trace-section">
    <div class="collapsible-header" onclick="toggleSection('workflow-trace-section')">
        <h3 class="section-title">
            <span class="icon">üîÑ</span>
            Conversion Workflow Trace
        </h3>
        <span class="collapsible-toggle">‚ñº</span>
    </div>

    <div class="collapsible-content">
        <div class="workflow-timeline">
        {% for step in workflow_trace %}
            <div class="timeline-item status-{{ step.status | lower }}">
                <div class="timeline-marker">
                    <div class="timeline-dot status-{{ step.status | lower }}">
                        {% if step.status == 'COMPLETED' %}‚úì
                        {% elif step.status == 'FAILED' %}‚úó
                        {% elif step.status == 'SKIPPED' %}‚óã
                        {% else %}‚Ä¢
                        {% endif %}
                    </div>
                    {% if not loop.last %}
                        <div class="timeline-line"></div>
                    {% endif %}
                </div>

                <div class="timeline-content">
                    <div class="timeline-header">
                        <h4 class="timeline-title">{{ step.step_name | format_field_name }}</h4>
                        <span class="timeline-timestamp">{{ step.timestamp | format_timestamp }}</span>
                    </div>

                    {% if step.description %}
                    <p class="timeline-description">{{ step.description }}</p>
                    {% endif %}

                    {% if step.details %}
                    <div class="timeline-details">
                        {% if step.details is mapping %}
                            <dl class="details-list">
                                {% for key, value in step.details.items() %}
                                    <dt class="details-key">{{ key | format_field_name }}:</dt>
                                    <dd class="details-value">
                                        {% if value is mapping or value is iterable and value is not string %}
                                            <pre class="details-json">{{ value | tojson(indent=2) }}</pre>
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </dd>
                                {% endfor %}
                            </dl>
                        {% else %}
                            <p>{{ step.details }}</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if step.duration_ms %}
                    <div class="timeline-duration">
                        <span class="duration-icon">‚è±</span>
                        Duration: {{ step.duration_ms | format_duration }}
                    </div>
                    {% endif %}

                    {% if step.error %}
                    <div class="timeline-error">
                        <strong>Error:</strong> {{ step.error }}
                    </div>
                    {% endif %}

                    {% if step.warnings %}
                    <div class="timeline-warnings">
                        <strong>Warnings:</strong>
                        <ul class="warnings-list">
                            {% for warning in step.warnings %}
                                <li>{{ warning }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
        </div>

        {% if workflow_trace|length == 0 %}
        <div class="empty-state">
            <p>No workflow trace available.</p>
        </div>
        {% endif %}

        {# Enhanced: Detailed Process Logs - Sequential View #}
        {% if detailed_logs_sequential %}
        <div class="detailed-logs-section">
            <div class="detailed-logs-header">
                <h4 class="detailed-logs-title">
                    <span class="icon">üìã</span>
                    Detailed Process Logs
                    <span class="logs-hint">(Scientific Transparency & Audit Trail)</span>
                </h4>
                <p class="detailed-logs-description">
                    Complete chronological execution log for reproducibility and scientific transparency.
                    Each log entry is tagged with its workflow stage for easy filtering while preserving the natural flow of events.
                </p>
            </div>

            {# Log filtering controls - Dual filters for level and stage #}
            <div class="log-filters">
                <label for="log-level-filter">Filter by level:</label>
                <select id="log-level-filter" class="filter-select" onchange="filterDetailedLogs()">
                    <option value="all">All Levels</option>
                    <option value="INFO">INFO</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>

                <label for="log-stage-filter" style="margin-left: 20px;">Filter by process:</label>
                <select id="log-stage-filter" class="filter-select" onchange="filterDetailedLogs()">
                    <option value="all">All Processes</option>
                    {% for stage_option in stage_options %}
                    <option value="{{ stage_option.value }}">{{ stage_option.label }}</option>
                    {% endfor %}
                </select>
            </div>

            {# Display all logs sequentially with stage tags #}
            <div class="logs-sequential">
                <div class="log-entries">
                    {% for log in detailed_logs_sequential %}
                    <div class="log-entry log-level-{{ log.level | lower }}"
                         data-level="{{ log.level }}"
                         data-stage="{{ log.stage }}">
                        <div class="log-entry-header">
                            {# Stage badge - visual tag for workflow stage #}
                            <span class="stage-badge stage-{{ log.stage }}">
                                {{ log.stage_icon }} {{ log.stage_display }}
                            </span>

                            {# Level badge #}
                            <span class="log-level-badge log-level-{{ log.level | lower }}">
                                {{ log.level }}
                            </span>

                            {# Timestamp #}
                            <span class="log-timestamp">{{ log.timestamp | format_timestamp }}</span>
                        </div>

                        {# Log message #}
                        <div class="log-message">{{ log.message }}</div>

                        {# Optional context data #}
                        {% if log.context %}
                        <div class="log-context-container">
                            <button class="log-context-toggle"
                                    onclick="toggleLogContext(this)">
                                <span class="toggle-icon">‚ñ∂</span> Show Context
                            </button>
                            <pre class="log-context" style="display: none;">{{ log.context | tojson(indent=2) }}</pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# Log file reference if available #}
            {% if log_file_path %}
            <div class="log-file-reference">
                <strong>üìÑ Complete log file:</strong>
                <code>{{ log_file_path }}</code>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">
                    This file contains the complete unfiltered execution log for this conversion session.
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
