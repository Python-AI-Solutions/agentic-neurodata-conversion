============================= test session starts =============================
collected 340 items

tests\integration\test_mcp_server.py ...................                 [  5%]
tests\unit\test_agent_registry.py ............                           [  9%]
tests\unit\test_api_health.py ................                           [ 13%]
tests\unit\test_api_internal.py ...................                      [ 19%]
tests\unit\test_api_sessions_clarify.py ..............                   [ 23%]
tests\unit\test_api_sessions_init.py ..............                      [ 27%]
tests\unit\test_api_sessions_result.py ..............F                   [ 32%]
tests\unit\test_api_sessions_status.py ..................                [ 37%]
tests\unit\test_base_agent.py ..................                         [ 42%]
tests\unit\test_config.py ...........................                    [ 50%]
tests\unit\test_context_manager.py ..s.............F...F.....s..         [ 59%]
tests\unit\test_conversation_agent_clarify.py ......                     [ 60%]
tests\unit\test_conversation_agent_edge_cases.py .......                 [ 62%]
tests\unit\test_conversation_agent_format.py .....                       [ 64%]
tests\unit\test_conversation_agent_metadata.py .........                 [ 67%]
tests\unit\test_conversation_agent_session.py ..........                 [ 70%]
tests\unit\test_conversation_agent_validation.py ........                [ 72%]
tests\unit\test_conversion_agent_all.py ...............                  [ 76%]
tests\unit\test_conversion_agent_convert.py ........                     [ 79%]
tests\unit\test_fixtures.py ..................                           [ 84%]
tests\unit\test_main.py ..............                                   [ 88%]
tests\unit\test_message_router.py ..............                         [ 92%]
tests\unit\test_models.py .........................                      [100%]

================================== FAILURES ===================================
_ TestSessionResultEndpoint.test_result_handles_missing_validation_report_path _
tests\unit\test_api_sessions_result.py:374: in test_result_handles_missing_validation_report_path
    response = client.get("/api/v1/sessions/test-session-005/result")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\starlette\testclient.py:479: in get
    return super().get(
.pixi\envs\default\Lib\site-packages\httpx\_client.py:1053: in get
    return self.request(
.pixi\envs\default\Lib\site-packages\starlette\testclient.py:451: in request
    return super().request(
.pixi\envs\default\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
.pixi\envs\default\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.pixi\envs\default\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
.pixi\envs\default\Lib\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
.pixi\envs\default\Lib\site-packages\anyio\from_thread.py:321: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
.pixi\envs\default\Lib\site-packages\anyio\from_thread.py:252: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\fastapi\applications.py:1133: in __call__
    await super().__call__(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
.pixi\envs\default\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
.pixi\envs\default\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.pixi\envs\default\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.pixi\envs\default\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
.pixi\envs\default\Lib\site-packages\fastapi\routing.py:123: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.pixi\envs\default\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.pixi\envs\default\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.pixi\envs\default\Lib\site-packages\fastapi\routing.py:109: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\fastapi\routing.py:389: in app
    raw_response = await run_endpoint_function(
.pixi\envs\default\Lib\site-packages\fastapi\routing.py:288: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
agentic_neurodata_conversion\mcp_server\api\sessions.py:422: in get_session_result
    or session.output_report_path
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
.pixi\envs\default\Lib\site-packages\pydantic\main.py:1026: in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E   AttributeError: 'SessionContext' object has no attribute 'output_report_path'
___________ TestUpdateSession.test_update_session_updates_timestamp ___________
tests\unit\test_context_manager.py:340: in test_update_session_updates_timestamp
    retrieved = await context_manager.get_session(sample_session.session_id)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
agentic_neurodata_conversion\mcp_server\context_manager.py:154: in get_session
    return SessionContext(**session_dict)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionContext
E   created_at
E     Input should be a valid datetime or date, unexpected extra characters at the end of the input [type=datetime_from_date_parsing, input_value='2025-10-17T05:10:10.427653+00:00Z', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.12/v/datetime_from_date_parsing
______________ TestConcurrentOperations.test_concurrent_updates _______________
tests\unit\test_context_manager.py:410: in test_concurrent_updates
    await asyncio.gather(
agentic_neurodata_conversion\mcp_server\context_manager.py:193: in update_session
    session = await self.get_session(session_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
agentic_neurodata_conversion\mcp_server\context_manager.py:154: in get_session
    return SessionContext(**session_dict)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for SessionContext
E   created_at
E     Input should be a valid datetime or date, unexpected extra characters at the end of the input [type=datetime_from_date_parsing, input_value='2025-10-17T05:10:10.641924+00:00Z', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.12/v/datetime_from_date_parsing
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.8-final-0 _______________

Name                                                         Stmts   Miss Branch BrPart  Cover   Missing
--------------------------------------------------------------------------------------------------------
agentic_neurodata_conversion\agents\__main__.py                 64     64     18      0     0%   3-139
agentic_neurodata_conversion\agents\base_agent.py               85      4     16      3    93%   176->163, 201, 206, 264, 280
agentic_neurodata_conversion\agents\conversation_agent.py      116      4     42      5    94%   102->101, 147->145, 193->189, 349->348, 419-423
agentic_neurodata_conversion\agents\conversion_agent.py         98      1     32      4    96%   29, 112->115, 115->118, 118->121, 121->124
agentic_neurodata_conversion\agents\evaluation_agent.py          8      2      0      0    75%   19, 31
agentic_neurodata_conversion\config.py                          74      2     14      2    95%   106, 140
agentic_neurodata_conversion\mcp_server\agent_registry.py       17      0      0      0   100%
agentic_neurodata_conversion\mcp_server\api\health.py           22      0      2      0   100%
agentic_neurodata_conversion\mcp_server\api\internal.py         35      0      4      0   100%
agentic_neurodata_conversion\mcp_server\api\sessions.py        110      7     36      3    93%   91, 144-145, 160-161, 242, 409
agentic_neurodata_conversion\mcp_server\context_manager.py      75      7     20      4    88%   58-63, 67->exit, 70-71, 110, 190, 231
agentic_neurodata_conversion\mcp_server\main.py                 31      0      0      0   100%
agentic_neurodata_conversion\mcp_server\message_router.py       26      0      2      0   100%
agentic_neurodata_conversion\models\api_models.py               44      0      0      0   100%
agentic_neurodata_conversion\models\mcp_message.py              22      0      0      0   100%
agentic_neurodata_conversion\models\session_context.py          75      0      0      0   100%
--------------------------------------------------------------------------------------------------------
TOTAL                                                          902     91    186     21    88%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
Coverage JSON written to file coverage.json
Required test coverage of 80% reached. Total coverage: 88.05%
=========================== short test summary info ===========================
FAILED tests/unit/test_api_sessions_result.py::TestSessionResultEndpoint::test_result_handles_missing_validation_report_path
FAILED tests/unit/test_context_manager.py::TestUpdateSession::test_update_session_updates_timestamp
FAILED tests/unit/test_context_manager.py::TestConcurrentOperations::test_concurrent_updates
================== 3 failed, 335 passed, 2 skipped in 20.81s ==================
